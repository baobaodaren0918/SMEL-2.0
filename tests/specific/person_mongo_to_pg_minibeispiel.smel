-- SMEL Mini-Example: MongoDB -> PostgreSQL (Specific Operations Version)
-- Person Document (multi-level nested objects + arrays) -> Normalized Tables
-- Direction: Denormalized (Embedded) -> Normalized (3NF)
-- Tests: Multiple operation types (FLATTEN, COPY, UNWIND, CAST, RENAME)
-- Syntax: SMEL_Specific.g4 with explicit entity.field syntax

MIGRATION person_mongo_to_pg:1.0
FROM DOCUMENT TO RELATIONAL
USING person_schema:1

-- ============================================
-- Source: MongoDB Person Document
-- ============================================
-- {
--   _id: "p001",
--   name: "Zhang San",
--   age: "28",                              -- Note: stored as string in MongoDB
--   address: {                              -- Embedded object (1:1)
--     street: "Hauptstrasse 10",
--     city: "Berlin"
--   },
--   employment: {                           -- Embedded object (1:1)
--     position: "Software Engineer",
--     company: {                            -- Embedded object (1:1)
--       name: "Tech Corp",
--       address: {                          -- Embedded object (1:1)
--         street: "Business Str 5",
--         city: "Munich"
--       }
--     }
--   },
--   tags: ["student", "developer"],         -- Array (1:N)
--   knows: ["p002", "p003"]                 -- Array M:N relationship
-- }

-- ============================================
-- Target: PostgreSQL 3NF Tables
-- ============================================
-- person (person_id, name, age)                    -- age: INTEGER
-- address (address_id, street, city, person_id)
-- employment (employment_id, position, person_id)
-- company (company_id, name, employment_id)
-- company_address (company_address_id, street, city, company_id)
-- person_tag (person_tag_id, tag_value, person_id)
-- person_knows (person_id, knows_person_id)

-- ============================================
-- Step 1: RENAME_FEATURE - Rename _id to person_id
-- ============================================
-- Do this first so all subsequent REFERENCES use person_id

RENAME_FEATURE _id TO person_id IN person

-- ============================================
-- Step 2: CAST - Type conversion
-- ============================================

CAST person.age TO Integer

-- ============================================
-- Step 3: FLATTEN - Extract address (1st level)
-- ============================================
-- Source: embedded object (1:1) -> ONE_TO_ONE relationship

FLATTEN person.address AS address
COPY person.address.street TO address.street
COPY person.address.city TO address.city
ADD_PRIMARY_KEY address.address_id AS String
ADD_REFERENCE address.person_id REFERENCES person(person_id) WITH CARDINALITY ONE_TO_ONE

-- ============================================
-- Step 4: FLATTEN - Extract employment (1st level)
-- ============================================
-- Source: embedded object (1:1) -> ONE_TO_ONE relationship

FLATTEN person.employment AS employment
COPY person.employment.position TO employment.position
ADD_PRIMARY_KEY employment.employment_id AS String
ADD_REFERENCE employment.person_id REFERENCES person(person_id) WITH CARDINALITY ONE_TO_ONE

-- ============================================
-- Step 5: FLATTEN - Extract company (2nd level)
-- ============================================
-- Source: embedded object (1:1) -> ONE_TO_ONE relationship
-- Note: Use FULL PATH from original source

FLATTEN person.employment.company AS company
COPY person.employment.company.name TO company.name
ADD_PRIMARY_KEY company.company_id AS String
ADD_REFERENCE company.employment_id REFERENCES employment(employment_id) WITH CARDINALITY ONE_TO_ONE

-- ============================================
-- Step 6: FLATTEN - Extract company address (3rd level)
-- ============================================
-- Source: embedded object (1:1) -> ONE_TO_ONE relationship
-- Note: Use FULL PATH from original source

FLATTEN person.employment.company.address AS company_address
COPY person.employment.company.address.street TO company_address.street
COPY person.employment.company.address.city TO company_address.city
ADD_PRIMARY_KEY company_address.company_address_id AS String
ADD_REFERENCE company_address.company_id REFERENCES company(company_id) WITH CARDINALITY ONE_TO_ONE

-- ============================================
-- Step 7: UNWIND - Expand tags array into table
-- ============================================
-- Source: array (1:N) -> ONE_TO_MANY relationship

UNWIND person.tags[] INTO person_tag
RENAME_FEATURE value TO tag_value IN person_tag
ADD_PRIMARY_KEY person_tag.person_tag_id AS String
ADD_REFERENCE person_tag.person_id REFERENCES person(person_id) WITH CARDINALITY ONE_TO_MANY

-- ============================================
-- Step 8: UNWIND - Expand knows array into M:N join table
-- ============================================
-- Source: array M:N -> Composite PK + TWO FK relationships

UNWIND person.knows[] INTO person_knows
RENAME_FEATURE value TO knows_person_id IN person_knows
ADD_REFERENCE person_knows.person_id REFERENCES person(person_id) WITH CARDINALITY ONE_TO_MANY
ADD_REFERENCE person_knows.knows_person_id REFERENCES person(person_id) WITH CARDINALITY ONE_TO_MANY
ADD_PRIMARY_KEY (person_id, knows_person_id) TO person_knows
